<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Music Video Generator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip CDN for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Theme Defaults */
            --bg-color-body: #f0f2f5;
            --bg-color-app: rgba(255, 255, 255, 0.95);
            --text-color-primary: #1a202c; /* gray-900 */
            --text-color-secondary: #4a5568; /* gray-700 */
            --text-color-muted: #718096; /* gray-500 */
            --border-color-light: #e2e8f0; /* gray-200 */
            --border-color-medium: #cbd5e0; /* gray-300 */
            --shadow-color-light: rgba(0, 0, 0, 0.05);
            --shadow-color-medium: rgba(0, 0, 0, 0.15);
            --input-bg-color: #ffffff;
            --input-border-color: #cbd5e0;
            --input-focus-border-color: #4c83fc; /* blue-500 equivalent */
            --input-focus-shadow: rgba(76, 131, 252, 0.3);
            --button-default-bg: #4c83fc; /* blue-500 equivalent */
            --button-default-hover-bg: #2e6ffc;

            --button-purple-bg: #8b5cf6; /* purple-500 */
            --button-purple-hover-bg: #7c3aed;

            --button-indigo-bg: #6366f1; /* indigo-500 */
            --button-indigo-hover-bg: #4f46e5;

            --button-green-bg: #22c55e; /* green-500 */
            --button-green-hover-bg: #16a34a;

            --button-red-bg: #ef4444; /* red-500 */
            --button-red-hover-bg: #dc2626;

            --button-teal-bg: #14b8a6; /* teal-500 */
            --button-teal-hover-bg: #0d9488;

            --button-disabled-bg: #93c5fd; /* blue-300 */
            --tab-color-inactive: #64748b; /* slate-500 */
            --tab-bg-hover: #eff6ff; /* blue-50 */
            --tab-color-active: #4c83fc; /* blue-500 equivalent */
            --tab-border-active: #4c83fc; /* blue-500 equivalent */
            --upload-bg-color: #f0f8ff; /* blue-50 */
            --upload-border-color: #9bc5f9; /* blue-300 */
            --upload-hover-bg: #e6f2ff; /* lighter blue */
            --gallery-item-bg: #ffffff;
            --gallery-item-border: #cfdceb;
            --gallery-item-shadow: rgba(0, 0, 0, 0.1);
            --gallery-button-bg: #60a5fa; /* blue-400 */
            --gallery-button-hover-bg: #3b82f6; /* blue-500 */
        }

        /* Dark Theme */
        body[data-theme='dark'] {
            --bg-color-body: #1a202c; /* Darker gray */
            --bg-color-app: rgba(45, 55, 72, 0.95); /* Dark slate gray */
            --text-color-primary: #f7fafc; /* Lighter white */
            --text-color-secondary: #e2e8f0; /* Lighter gray */
            --text-color-muted: #a0aec0; /* Darker muted gray */
            --border-color-light: #2d3748; /* Dark border */
            --border-color-medium: #4a5568; /* Medium dark border */
            --shadow-color-light: rgba(0, 0, 0, 0.3);
            --shadow-color-medium: rgba(0, 0, 0, 0.5);
            --input-bg-color: #2d3748;
            --input-border-color: #4a5568;
            --input-focus-border-color: #63b3ed; /* light blue */
            --input-focus-shadow: rgba(99, 179, 237, 0.4);
            --button-default-bg: #4299e1; /* blue-400 */
            --button-default-hover-bg: #3182ce;

            --button-purple-bg: #9f7aea; /* purple-400 */
            --button-purple-hover-bg: #805ad5;

            --button-indigo-bg: #7f9cf6; /* indigo-400 */
            --button-indigo-hover-bg: #667eea;

            --button-green-bg: #48bb78; /* green-400 */
            --button-green-hover-bg: #38a169;

            --button-red-bg: #fc8181; /* red-400 */
            --button-red-hover-bg: #e53e3e;

            --button-teal-bg: #4fd1c5; /* teal-400 */
            --button-teal-hover-bg: #38b2ac;

            --button-disabled-bg: #4a5568; /* gray-700 */
            --tab-color-inactive: #a0aec0; /* gray-500 */
            --tab-bg-hover: #2d3748; /* gray-800 */
            --tab-color-active: #63b3ed; /* light blue */
            --tab-border-active: #63b3ed; /* light blue */
            --upload-bg-color: #2d3748;
            --upload-border-color: #4a5568;
            --upload-hover-bg: #4a5568;
            --gallery-item-bg: #2d3748;
            --gallery-item-border: #4a5568;
            --gallery-item-shadow: rgba(0, 0, 0, 0.3);
            --gallery-button-bg: #63b3ed;
            --gallery-button-hover-bg: #4299e1;
        }

        /* Base styles using CSS variables */
        body {
            font-family: "Inter", sans-serif;
            background-color: var(--bg-color-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('https://placehold.co/1920x1080/cfe2f3/ffffff?text=Abstract+Background');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: multiply;
            color: var(--text-color-primary); /* Base text color */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transitions */
        }
        #app-container {
            background-color: var(--bg-color-app);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color-medium);
            padding: 28px;
            width: 100%;
            max-width: 850px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, backdrop-filter 0.3s ease;
        }
        .input-group label {
            color: var(--text-color-secondary);
        }
        input[type="text"], input[type="number"], select, textarea {
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color-primary);
            box-shadow: inset 0 1px 3px var(--shadow-color-light);
            transition: all 0.3s ease-in-out;
            padding: 12px 18px; /* Added here for consistency */
            border-radius: 10px; /* Added here for consistency */
            font-size: 1rem; /* Added here for consistency */
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none; /* Removed default outline */
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 0 4px var(--input-focus-shadow);
        }
        button {
            cursor: pointer;
            color: white; /* Always white text for buttons */
            border: none;
            font-weight: 600;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 5px var(--shadow-color-light);
            position: relative;
            overflow: hidden;
            background-color: var(--button-default-bg); /* Default button color */
        }
        button:hover:not(:disabled) {
            background-color: var(--button-default-hover-bg);
            box-shadow: 0 4px 10px var(--shadow-color-medium);
            transform: translateY(-1px);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 3px var(--shadow-color-light);
        }
        button:disabled {
            background-color: var(--button-disabled-bg);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Override specific button colors */
        #generate-storyboard-button { background-color: var(--button-indigo-bg); }
        #generate-storyboard-button:hover:not(:disabled) { background-color: var(--button-indigo-hover-bg); }
        #enhance-prompt-button { background-color: var(--button-purple-bg); }
        #enhance-prompt-button:hover:not(:disabled) { background-color: var(--button-purple-hover-bg); }
        #generate-button { background-color: var(--button-default-bg); } /* Using default for generate button */
        #generate-button:hover:not(:disabled) { background-color: var(--button-default-hover-bg); }
        #play-button { background-color: var(--button-green-bg); }
        #play-button:hover:not(:disabled) { background-color: var(--button-green-hover-bg); }
        #stop-button { background-color: var(--button-red-bg); }
        #stop-button:hover:not(:disabled) { background-color: var(--button-red-hover-bg); }
        #download-images-button { background-color: var(--button-indigo-bg); }
        #download-images-button:hover:not(:disabled) { background-color: var(--button-indigo-hover-bg); }
        #download-zip-button { background-color: var(--button-teal-bg); }
        #download-zip-button:hover:not(:disabled) { background-color: var(--button-teal-hover-bg); }


        #image-display-container {
            width: 100%;
            min-height: 300px;
            background-color: var(--border-color-light); /* Using a lighter border color for this area */
            border-radius: 12px;
            box-shadow: inset 0 2px 5px var(--shadow-color-light);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        #image-display {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            border-radius: 12px;
        }
        #loading-indicator, #llm-loading-indicator {
            color: var(--text-color-secondary);
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
        }
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
            justify-content: center;
        }
        .controls-row button {
            flex-grow: 1;
            min-width: 130px;
        }
        .size-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
        }
        .size-inputs > div {
            flex: 1;
            min-width: 150px;
        }
        .upload-section {
            border-top: 1px solid var(--border-color-light);
            padding-top: 24px;
            margin-top: 24px;
            width: 100%;
            text-align: center;
        }
        .upload-section label {
            margin-bottom: 12px;
            display: block;
            font-weight: 700;
            color: var(--text-color-secondary);
        }
        .upload-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border: 2px dashed var(--upload-border-color);
            border-radius: 10px;
            background-color: var(--upload-bg-color);
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: inset 0 1px 3px var(--shadow-color-light);
        }
        .upload-input-container:hover {
            background-color: var(--upload-hover-bg);
            border-color: var(--button-default-bg);
        }
        .upload-input-container span {
            color: var(--text-color-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #original-image-preview-container {
            width: 100%;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color-light);
            text-align: center;
            display: none;
        }
        #original-image-preview-container h3 {
            color: var(--text-color-secondary);
        }
        #original-image-preview {
            max-width: 100%;
            height: auto;
            max-height: 280px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color-light);
            margin-top: 12px;
        }
        #uploaded-image-gallery-container {
            width: 100%;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color-light);
            text-align: center;
            display: none;
        }
        #uploaded-image-gallery-container h3 {
            color: var(--text-color-secondary);
        }
        #uploaded-image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .gallery-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--gallery-item-border);
            border-radius: 10px;
            padding: 10px;
            background-color: var(--gallery-item-bg);
            box-shadow: 0 2px 8px var(--gallery-item-shadow);
            transition: all 0.2s ease-in-out;
        }
        .gallery-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color-medium); /* Corrected from 4g to 4px */
        }
        .gallery-item img {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color-light);
        }
        .gallery-item .item-controls {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        .gallery-item .item-controls button {
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 8px;
            background-color: var(--gallery-button-bg);
            box-shadow: none;
        }
        .gallery-item .item-controls button:hover {
            background-color: var(--gallery-button-hover-bg);
            transform: none;
            box-shadow: none;
        }

        /* Tab Specific Styles */
        #tab-navigation {
            display: flex;
            width: 100%;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color-light);
        }
        .tab-button {
            flex: 1;
            padding: 12px 10px;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--tab-color-inactive);
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease-in-out;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: none;
        }
        .tab-button:hover:not(.active) {
            color: var(--tab-color-active);
            background-color: var(--tab-bg-hover);
        }
        .tab-button.active {
            color: var(--tab-color-active);
            border-bottom-color: var(--tab-border-active);
            background-color: var(--bg-color-app);
            font-weight: 700;
        }

        /* SVG Icon Styles */
        .tab-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .tab-content {
            width: 100%;
            display: none;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Specific text colors via CSS variables */
        h1.text-3xl { color: var(--text-color-primary); }
        p.text-gray-600 { color: var(--text-color-secondary); }
        .text-gray-700 { color: var(--text-color-secondary); } /* Labels, headers */
        .text-gray-500 { color: var(--text-color-muted); } /* Notes */


        @media (max-width: 640px) {
            #app-container {
                padding: 18px;
                gap: 18px;
            }
            .controls-row button {
                min-width: unset;
                width: 100%;
            }
            .tab-button {
                font-size: 0.9rem;
                padding: 10px 5px;
            }
            .tab-button svg {
                width: 20px;
                height: 20px;
            }
            #language-select, #theme-select {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Language Selector -->
        <div class="input-group mb-4">
            <label for="language-select" class="text-gray-700 font-medium" data-key="languageLabel">Language:</label>
            <select id="language-select" class="w-full">
                <option value="en">English</option>
                <option value="vi">Tiếng Việt</option>
                <option value="es">Español</option>
                <option value="zh">中文</option>
            </select>
        </div>

        <!-- Theme Selector -->
        <div class="input-group mb-4">
            <label for="theme-select" class="text-gray-700 font-medium" data-key="themeLabel">Theme:</label>
            <select id="theme-select" class="w-full">
                <option value="system" data-key="themeSystem"></option>
                <option value="light" data-key="themeLight"></option>
                <option value="dark" data-key="themeDark"></option>
            </select>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 text-center mb-4" data-key="mainTitle">🎵 Music Video Generator 🎬</h1>
        <p class="text-gray-600 text-center mb-6" data-key="mainDescription">Enter a prompt to generate a sequence of images or upload your own. Play them as a slideshow along with your favorite music!</p>

        <!-- Tab Navigation -->
        <div id="tab-navigation">
            <button class="tab-button active" data-tab="ai-create" data-key="tabAiCreate">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                    <path d="M0 0h24v24H0z" fill="none"/>
                </svg>
                Create with AI
            </button>
            <button class="tab-button" data-tab="upload" data-key="tabUploadImages">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
                    <path d="M0 0h24v24H0z" fill="none"/>
                </svg>
                Upload Images
            </button>
        </div>

        <!-- Tab Content Containers -->
        <div id="ai-create-tab-content" class="tab-content active">
            <!-- Overall Story / Theme Input -->
            <div class="input-group">
                <label for="story-theme-input" class="text-gray-700 font-medium" data-key="storyThemeLabel">Overall Story / Theme:</label>
                <textarea id="story-theme-input" rows="3" placeholder="e.g., 'A hero's journey through a cybernetic wasteland, from desolation to hope.'" class="w-full" data-key="storyThemePlaceholder"></textarea>
                <button id="generate-storyboard-button" class="mt-2" data-key="generateStoryboardButton">✨ Generate Storyboard Prompts</button>
            </div>

            <!-- Image Prompt (now within AI Create tab) -->
            <div class="input-group">
                <label for="prompt-input" class="text-gray-700 font-medium" data-key="imagePromptLabel">Image Prompt (will be populated by Storyboard or manual):</label>
                <textarea id="prompt-input" rows="4" placeholder="e.g., 'futuristic city at night, neon lights, with subtle steam rising from the streets and a vibrant, ethereal glow over the skyscrapers. A lone, abstract figure stands observing the scene, rendered in a painterly style with rich textures and deep colors.'" class="w-full" data-key="imagePromptPlaceholder"></textarea>
                <button id="enhance-prompt-button" class="mt-2" data-key="enhancePromptButton">✨ Enhance Prompt</button>
                <p id="llm-loading-indicator" style="display:none;"></p>
            </div>

            <!-- Number of Images (now within AI Create tab) -->
            <div class="input-group">
                <label for="image-count" class="text-gray-700 font-medium" data-key="numImagesLabel">Number of Images (max 20):</label>
                <input type="number" id="image-count" value="5" min="1" max="20" class="w-full">
            </div>

            <!-- Size Inputs (now within AI Create tab) -->
            <div class="size-inputs">
                <div class="input-group">
                    <label for="image-width" class="text-gray-700 font-medium" data-key="imageWidthLabel">Image Width:</label>
                    <select id="image-width" class="w-full">
                        <option value="512">512px</option>
                        <option value="768">768px</option>
                        <option value="1024" selected>1024px (HD)</option>
                        <option value="2048">2048px (2K)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="image-height" class="text-gray-700 font-medium" data-key="imageHeightLabel">Image Height:</label>
                    <select id="image-height" class="w-full">
                        <option value="512">512px</option>
                        <option value="768">768px</option>
                        <option value="1024">1024px</option>
                        <option value="2048">2048px</option>
                    </select>
                </div>
            </div>

            <!-- Slideshow Interval (now within AI Create tab) -->
            <div class="input-group">
                <label for="interval-input" class="text-gray-700 font-medium" data-key="slideshowIntervalLabel">Slideshow Interval (milliseconds):</label>
                <input type="number" id="interval-input" value="1000" min="100" max="5000" class="w-full">
            </div>

            <!-- Generate Images Button (now within AI Create tab) -->
            <button id="generate-button" data-key="generateImagesButton">Generate Images</button>
        </div>

        <div id="upload-tab-content" class="tab-content">
             <div class="upload-section">
                <label class="text-gray-700 text-lg font-bold mb-3" data-key="uploadImagesHeader">Upload Your Own Images</label>
                <div id="upload-input-container-div" class="upload-input-container">
                    <input type="file" id="upload-input" multiple accept="image/*">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
                            <path d="M0 0h24v24H0z" fill="none"/>
                        </svg>
                        <span data-key="uploadInputSpan">Click here to select images</span>
                    </span>
                </div>
                <p id="upload-status" class="text-gray-600 text-sm mt-2" style="display:none;"></p>
            </div>
        </div>

        <!-- Controls Row (Persistent outside tabs) -->
        <div class="controls-row">
            <button id="play-button" disabled data-key="playVideoButton">Play Video</button>
            <button id="stop-button" disabled data-key="stopVideoButton">Stop Video</button>
            <button id="download-images-button" disabled data-key="downloadAllImagesButton">⬇️ Download All Images</button>
            <button id="download-zip-button" disabled data-key="downloadZipButton">⬇️ Download Video Frames (ZIP)</button>
        </div>

        <!-- Image Display (Persistent outside tabs) -->
        <div id="image-display-container" class="relative">
            <img id="image-display" src="" alt="Generated Image">
            <p id="loading-indicator" style="display:none;"></p>
        </div>

        <!-- Original Uploaded Image Preview (Persistent outside tabs) -->
        <div id="original-image-preview-container">
            <h3 class="text-xl font-bold text-gray-700 mb-2" data-key="originalImagePreviewHeader">Original Uploaded Image Preview (First Uploaded Image)</h3>
            <img id="original-image-preview" src="" alt="Original Uploaded Image">
        </div>

        <!-- Uploaded Image Gallery (Persistent outside tabs) -->
        <div id="uploaded-image-gallery-container">
            <h3 class="text-xl font-bold text-gray-700 mb-2" data-key="uploadedImageGalleryHeader">Uploaded Image Gallery (Click ⬆️ or ⬇️ to reorder)</h3>
            <div id="uploaded-image-gallery">
                <!-- Image thumbnails will be inserted here by JavaScript -->
            </div>
            <p id="gallery-status" class="text-gray-600 text-sm mt-2" style="display:none;"></p>
        </div>

        <p class="text-sm text-gray-500 text-center mt-4" data-key="note1">*Please note: Music playback is not supported directly within this application. Please play your music in a separate tab or application.*</p>
        <p class="text-sm text-gray-500 text-center mt-2" data-key="note2">*This app generates image sequences. To create a full video file (e.g., MP4), download the frames as a ZIP and use external video editing software. Maximum supported image resolution for generation is 2K.*</p>
    </div>

    <script>
        console.log("Music Video Generator script loaded.");

        // Language specific translations
        const translations = {
            en: {
                appTitle: "Music Video Generator",
                languageLabel: "Language:",
                themeLabel: "Theme:",
                themeSystem: "System",
                themeLight: "Light",
                themeDark: "Dark",
                mainTitle: "🎵 Music Video Generator 🎬",
                mainDescription: "Enter a prompt to generate a sequence of images or upload your own. Play them as a slideshow along with your favorite music!",
                tabAiCreate: "Create with AI",
                tabUploadImages: "Upload Images",
                storyThemeLabel: "Overall Story / Theme:",
                storyThemePlaceholder: "e.g., 'A hero's journey through a cybernetic wasteland, from desolation to hope.'",
                generateStoryboardButton: "✨ Generate Storyboard Prompts",
                imagePromptLabel: "Image Prompt (will be populated by Storyboard or manual):",
                imagePromptPlaceholder: "e.g., 'futuristic city at night, neon lights, with subtle steam rising from the streets and a vibrant, ethereal glow over the skyscrapers. A lone, abstract figure stands observing the scene, rendered in a painterly style with rich textures and deep colors.'",
                enhancePromptButton: "✨ Enhance Prompt",
                llmLoadingMessage: "Enhancing prompt...",
                loadingGeneratingStoryboards: "Generating storyboard prompts...",
                numImagesLabel: "Number of Images (max 20):",
                imageWidthLabel: "Image Width:",
                imageHeightLabel: "Image Height:",
                slideshowIntervalLabel: "Slideshow Interval (milliseconds):",
                generateImagesButton: "Generate Images",
                playVideoButton: "Play Video",
                stopVideoButton: "Stop Video",
                downloadAllImagesButton: "⬇️ Download All Images",
                downloadZipButton: "⬇️ Download Video Frames (ZIP)",
                uploadImagesHeader: "Upload Your Own Images",
                uploadInputSpan: "Click here to select images",
                loadingIndicatorMessage: "Generating images... This may take a moment.",
                originalImagePreviewHeader: "Original Uploaded Image Preview (First Uploaded Image)",
                uploadedImageGalleryHeader: "Uploaded Image Gallery (Click ⬆️ or ⬇️ to reorder)",
                note1: "*Please note: Music playback is not supported directly within this application. Please play your music in a separate tab or application.*",
                note2: "*This app generates image sequences. To create a full video file (e.g., MP4), download the frames as a ZIP and use external video editing software. Maximum supported image resolution for generation is 2K.*",
                alertPromptEmpty: "Please enter an image prompt or generate storyboard prompts.",
                alertImageCountInvalid: "Please enter a valid number of images between 1 and 20.",
                alertImageDimensionsInvalid: "Please select valid image dimensions.",
                alertStoryboardThemeEmpty: "Please enter an overall story or theme to generate storyboard prompts.",
                alertStoryboardEmpty: "The AI generated an empty storyboard. Please try a different theme.",
                alertStoryboardParseError: "Failed to parse storyboard prompts from AI. Please try again.",
                alertStoryboardLLMContentError: "Could not generate storyboard prompts. The AI might not have returned valid content. Please try again.",
                alertImageGenHTTPError: "Error generating image. This might be due to an API key configuration issue in the environment. Please contact support if this persists.",
                alertImageGenNoPrediction: "Error: Could not generate one or more images. The image generation service might not have returned valid image data. Please try a different prompt or fewer images.",
                alertImageGenUnhandledError: "An unexpected error occurred during image generation. Please check the console for details and try again.",
                alertEnhancePromptEmpty: "Please enter a prompt to enhance.",
                alertEnhancePromptConflict: "Enhancing individual prompts is not available when a storyboard is active or when uploaded images are in use. Clear the content to enhance the main prompt.",
                alertEnhancePromptHTTPError: "Error enhancing prompt: ",
                alertEnhancePromptLLMContentError: "Could not enhance the prompt. The LLM might not have returned valid text. Please try again or rephrase your original prompt.",
                alertEnhancePromptUnhandledError: "An unexpected error occurred while enhancing the prompt. Please check the console for details and try again.",
                alertNoImagesToDownload: "No images to download. Please generate or upload images first.",
                alertNoImagesToZip: "No images to zip. Please generate or upload images first.",
                alertZipError: "An error occurred while creating or downloading the ZIP file. Please try again.",
                alertUploadFileReadError: "Failed to read file: ",
                alertNoValidImagesUploaded: "No valid images were uploaded.",
                alertUploadUnhandledError: "An error occurred during upload.",
                uploadProcessing: "Processing {{count}} images...",
                uploadedReady: "{{count}} images uploaded and ready!",
                loadingGenerating: "Generating images... This may take a moment.",
                loadingUploading: "Uploading images... This may take a moment.",
                loadingCreatingZip: "Creating ZIP file...",
                galleryStatus: "Showing {{count}} uploaded images.",
                moveUp: "⬆️ Move Up",
                moveDown: "⬇️ Move Down",
                slideshowStartAlert: "Please generate or upload images first to start the slideshow.",
                slideshowInvalidInterval: "Please enter a valid interval (at least 100ms).",
                alertNoImagesGenerated: "No images were generated. Please check your prompt and try again.",
            },
            vi: {
                appTitle: "Trình tạo Video Âm nhạc",
                languageLabel: "Ngôn ngữ:",
                themeLabel: "Chủ đề:",
                themeSystem: "Hệ thống",
                themeLight: "Sáng",
                themeDark: "Tối",
                mainTitle: "🎵 Trình tạo Video Âm nhạc �",
                mainDescription: "Nhập một lời nhắc để tạo chuỗi hình ảnh hoặc tải lên hình ảnh của riêng bạn. Phát chúng dưới dạng trình chiếu cùng với âm nhạc yêu thích của bạn!",
                tabAiCreate: "Tạo bằng AI",
                tabUploadImages: "Tải lên Hình ảnh",
                storyThemeLabel: "Câu chuyện / Chủ đề tổng thể:",
                storyThemePlaceholder: "ví dụ: 'Hành trình của một anh hùng qua vùng đất hoang tàn mạng lưới, từ sự hoang vắng đến hy vọng.'",
                generateStoryboardButton: "✨ Tạo Gợi ý Kịch bản",
                imagePromptLabel: "Lời nhắc hình ảnh (sẽ được điền từ Kịch bản hoặc thủ công):",
                imagePromptPlaceholder: "ví dụ: 'thành phố tương lai vào ban đêm, đèn neon, với hơi nước thoang thoảng bốc lên từ đường phố và ánh sáng rực rỡ, siêu nhiên trên các tòa nhà chọc trời. Một nhân vật trừu tượng đơn độc đang quan sát cảnh tượng, được thể hiện theo phong cách hội họa với kết cấu phong phú và màu sắc sâu sắc.'",
                enhancePromptButton: "✨ Nâng cao Gợi ý",
                llmLoadingMessage: "Đang nâng cao gợi ý...",
                loadingGeneratingStoryboards: "Đang tạo gợi ý kịch bản...",
                numImagesLabel: "Số lượng hình ảnh (tối đa 20):",
                imageWidthLabel: "Chiều rộng hình ảnh:",
                imageHeightLabel: "Chiều cao hình ảnh:",
                slideshowIntervalLabel: "Khoảng thời gian trình chiếu (mili giây):",
                generateImagesButton: "Tạo Hình ảnh",
                playVideoButton: "Phát Video",
                stopVideoButton: "Dừng Video",
                downloadAllImagesButton: "⬇️ Tải xuống Tất cả Hình ảnh",
                downloadZipButton: "⬇️ Tải xuống Khung Video (ZIP)",
                uploadImagesHeader: "Tải lên Hình ảnh Của Riêng Bạn",
                uploadInputSpan: "Nhấp vào đây để chọn hình ảnh",
                loadingIndicatorMessage: "Đang tạo hình ảnh... Vui lòng đợi trong giây lát.",
                originalImagePreviewHeader: "Xem trước Hình ảnh Gốc Đã Tải lên (Hình ảnh đầu tiên)",
                uploadedImageGalleryHeader: "Thư viện Hình ảnh Đã Tải lên (Nhấp ⬆️ hoặc ⬇️ để sắp xếp lại)",
                note1: "*Xin lưu ý: Ứng dụng này không hỗ trợ phát nhạc nhạc trực tiếp. Vui lòng phát nhạc của bạn trong một tab hoặc ứng dụng riêng biệt.*",
                note2: "*Ứng dụng này tạo ra các chuỗi hình ảnh. Để tạo tệp video đầy đủ (ví dụ: MP4), hãy tải xuống các khung dưới dạng ZIP và sử dụng phần mềm chỉnh sửa video bên ngoài. Độ phân giải hình ảnh tối đa được hỗ trợ để tạo là 2K.*",
                alertPromptEmpty: "Vui lòng nhập lời nhắc hình ảnh hoặc tạo lời nhắc kịch bản.",
                alertImageCountInvalid: "Vui lòng nhập số lượng hình ảnh hợp lệ từ 1 đến 20.",
                alertImageDimensionsInvalid: "Vui lòng chọn kích thước hình ảnh hợp lệ.",
                alertStoryboardThemeEmpty: "Vui lòng nhập một câu chuyện hoặc chủ đề tổng thể để tạo gợi ý kịch bản.",
                alertStoryboardEmpty: "AI đã tạo một kịch bản trống. Vui lòng thử một chủ đề khác.",
                alertStoryboardParseError: "Không thể phân tích cú pháp gợi ý kịch bản từ AI. Vui lòng thử lại.",
                alertStoryboardLLMContentError: "Không thể tạo gợi ý kịch bản. AI có thể không trả về nội dung hợp lệ. Vui lòng thử lại.",
                alertImageGenHTTPError: "Lỗi tạo hình ảnh. Điều này có thể do sự cố cấu hình khóa API trong môi trường. Vui lòng liên hệ với bộ phận hỗ trợ nếu sự cố này vẫn tiếp diễn.",
                alertImageGenNoPrediction: "Lỗi: Không thể tạo một hoặc nhiều hình ảnh. Dịch vụ tạo hình ảnh có thể không trả về dữ liệu hình ảnh hợp lệ. Vui lòng thử một lời nhắc khác hoặc độ phân giải nhỏ hơn.",
                alertImageGenUnhandledError: "Đã xảy ra lỗi không mong muốn trong quá trình tạo hình ảnh. Vui lòng kiểm tra bảng điều khiển để biết chi tiết và thử lại.",
                alertEnhancePromptEmpty: "Vui lòng nhập lời nhắc để nâng cao.",
                alertEnhancePromptConflict: "Tính năng nâng cao lời nhắc riêng lẻ không khả dụng khi kịch bản đang hoạt động hoặc khi hình ảnh đã tải lên đang được sử dụng. Vui lòng xóa nội dung để nâng cao lời nhắc chính.",
                alertEnhancePromptHTTPError: "Lỗi nâng cao lời nhắc: ",
                alertEnhancePromptLLMContentError: "Không thể nâng cao lời nhắc. LLM có thể không trả về văn bản hợp lệ. Vui lòng thử lại hoặc diễn đạt lại lời nhắc ban đầu của bạn.",
                alertEnhancePromptUnhandledError: "Đã xảy ra lỗi không mong muốn trong quá trình nâng cao lời nhắc. Vui lòng kiểm tra bảng điều khiển để biết chi tiết và thử lại.",
                alertNoImagesToDownload: "Không có hình ảnh nào để tải xuống. Vui lòng tạo hoặc tải lên hình ảnh trước.",
                alertNoImagesToZip: "Không có hình ảnh nào để nén. Vui lòng tạo hoặc tải lên hình ảnh trước.",
                alertZipError: "Đã xảy ra lỗi khi tạo hoặc tải xuống tệp ZIP. Vui lòng thử lại.",
                alertUploadFileReadError: "Không thể đọc tệp: ",
                alertNoValidImagesUploaded: "Không có hình ảnh hợp lệ nào được tải lên.",
                alertUploadUnhandledError: "Đã xảy ra lỗi trong quá trình tải lên.",
                uploadProcessing: "Đang xử lý {{count}} hình ảnh...",
                uploadedReady: "{{count}} hình ảnh đã tải lên và sẵn sàng!",
                loadingGenerating: "Đang tạo hình ảnh... Vui lòng đợi trong giây lát.",
                loadingUploading: "Đang tải lên hình ảnh... Vui lòng đợi trong giây lát.",
                loadingCreatingZip: "Đang tạo tệp ZIP...",
                galleryStatus: "Đang hiển thị {{count}} hình ảnh đã tải lên.",
                moveUp: "⬆️ Di chuyển lên",
                moveDown: "⬇️ Di chuyển xuống",
                slideshowStartAlert: "Vui lòng tạo hoặc tải lên hình ảnh trước để bắt đầu trình chiếu.",
                slideshowInvalidInterval: "Vui lòng nhập khoảng thời gian hợp lệ (ít nhất 100ms).",
                alertNoImagesGenerated: "Không có hình ảnh nào được tạo. Vui lòng kiểm tra lời nhắc của bạn và thử lại.",
            },
            es: {
                appTitle: "Generador de Videos Musicales",
                languageLabel: "Idioma:",
                themeLabel: "Tema:",
                themeSystem: "Sistema",
                themeLight: "Claro",
                themeDark: "Oscuro",
                mainTitle: "🎵 Generador de Videos Musicales 🎬",
                mainDescription: "Ingrese una instrucción para generar una secuencia de imágenes o suba las suyas. ¡Reprodúzcalas como una presentación de diapositivas junto con su música favorita!",
                tabAiCreate: "Crear con IA",
                tabUploadImages: "Subir Imágenes",
                storyThemeLabel: "Historia / Tema General:",
                storyThemePlaceholder: "Ej: 'El viaje de un héroe a través de un páramo cibernético, de la desolación a la esperanza.'",
                generateStoryboardButton: "✨ Generar Sugerencias de Guion Gráfico",
                imagePromptLabel: "Sugerencia de Imagen (se llenará con Guion Gráfico o manualmente):",
                imagePromptPlaceholder: "Ej: 'ciudad futurista por la noche, luces de neón, con vapor sutil elevándose de las calles y un brillo vibrante y etéreo sobre los rascacielos. Una figura solitaria y abstracta observa la escena, representada en un estilo pictórico con texturas ricas y colores profundos.'",
                enhancePromptButton: "✨ Mejorar Sugerencia",
                llmLoadingMessage: "Mejorando sugerencia...",
                loadingGeneratingStoryboards: "Generando sugerencias de guion gráfico...",
                numImagesLabel: "Número de Imágenes (máx. 20):",
                imageWidthLabel: "Ancho de Imagen:",
                imageHeightLabel: "Altura de Imagen:",
                slideshowIntervalLabel: "Intervalo de Presentación (milisegundos):",
                generateImagesButton: "Generar Imágenes",
                playVideoButton: "Reproducir Video",
                stopVideoButton: "Detener Video",
                downloadAllImagesButton: "⬇️ Descargar Todas las Imágenes",
                downloadZipButton: "⬇️ Descargar Cuadros de Video (ZIP)",
                uploadImagesHeader: "Subir Tus Propias Imágenes",
                uploadInputSpan: "Haz clic aquí para seleccionar imágenes",
                loadingIndicatorMessage: "Generando imágenes... Esto puede tomar un momento.",
                originalImagePreviewHeader: "Vista Previa de Imagen Original Subida (Primera Imagen Subida)",
                uploadedImageGalleryHeader: "Galería de Imágenes Subidas (Clic ⬆️ o ⬇️ para reordenar)",
                note1: "*Tenga en cuenta: La reproducción de música no es compatible directamente con esta aplicación. Por favor, reproduzca su música en una pestaña o aplicación separada.*",
                note2: "*Esta aplicación genera secuencias de imágenes. Para crear un archivo de video completo (ej: MP4), descargue los cuadros como un ZIP y use un software de edición de video externo. La resolución máxima de imagen soportada para la generación es 2K.*",
                alertPromptEmpty: "Por favor, ingrese una instrucción de imagen o genere instrucciones de guion gráfico.",
                alertImageCountInvalid: "Por favor, ingrese un número válido de imágenes entre 1 y 20.",
                alertImageDimensionsInvalid: "Por favor, seleccione dimensiones de imagen válidas.",
                alertStoryboardThemeEmpty: "Por favor, ingrese una historia o tema general para generar sugerencias de guion gráfico.",
                alertStoryboardEmpty: "La IA generó un guion gráfico vacío. Por favor, intente con un tema diferente.",
                alertStoryboardParseError: "No se pudo analizar las sugerencias del guion gráfico de la IA. Por favor, intente de nuevo.",
                alertStoryboardLLMContentError: "No se pudieron generar las sugerencias del guion gráfico. Es posible que la IA no haya devuelto contenido válido. Por favor, intente de nuevo.",
                alertImageGenHTTPError: "Error al generar la imagen. Esto podría deberse a un problema de configuración de la clave API en el entorno. Si el problema persiste, póngase en contacto con el soporte técnico.",
                alertImageGenNoPrediction: "Error: No se pudo generar una o más imágenes. Es posible que el servicio de generación de imágenes no haya devuelto datos de imagen válidos. Por favor, intente con una instrucción diferente o una resolución más pequeña.",
                alertImageGenUnhandledError: "Ocurrió un error inesperado durante la generación de la imagen. Por favor, revise la consola para más detalles e intente de nuevo.",
                alertEnhancePromptEmpty: "Por favor, ingrese una sugerencia para mejorar.",
                alertEnhancePromptConflict: "La mejora de sugerencias individuales no está disponible cuando hay un guion gráfico activo o cuando se están utilizando imágenes subidas. Borre el contenido para mejorar la sugerencia principal.",
                alertEnhancePromptHTTPError: "Error al mejorar la sugerencia: ",
                alertEnhancePromptLLMContentError: "No se pudo mejorar la sugerencia. Es posible que el LLM no haya devuelto texto válido. Por favor, intente de nuevo o reformule su sugerencia original.",
                alertEnhancePromptUnhandledError: "Ocurrió un error inesperado al mejorar la sugerencia. Por favor, revise la consola para más detalles e intente de nuevo.",
                alertNoImagesToDownload: "No hay imágenes para descargar. Por favor, genere o suba imágenes primero.",
                alertNoImagesToZip: "No hay imágenes para comprimir. Por favor, genere o suba imágenes primero.",
                alertZipError: "Ocurrió un error al crear o descargar el archivo ZIP. Por favor, intente de nuevo.",
                alertUploadFileReadError: "No se pudo leer el archivo: ",
                alertNoValidImagesUploaded: "No se subieron imágenes válidas.",
                alertUploadUnhandledError: "Ocurrió un error durante la subida.",
                uploadProcessing: "Procesando {{count}} imágenes...",
                uploadedReady: "{{count}} imágenes subidas y listas!",
                loadingGenerating: "Generando imágenes... Esto puede tomar un momento.",
                loadingUploading: "Subiendo imágenes... Esto puede tomar un momento.",
                loadingCreatingZip: "Creando archivo ZIP...",
                galleryStatus: "Mostrando {{count}} imágenes subidas.",
                moveUp: "⬆️ Mover arriba",
                moveDown: "⬇️ Mover abajo",
                slideshowStartAlert: "Por favor, genere o suba imágenes primero para iniciar la presentación.",
                slideshowInvalidInterval: "Por favor, ingrese un intervalo válido (al menos 100 ms).",
                alertNoImagesGenerated: "No se generaron imágenes. Por favor, revise su instrucción y pruebe de nuevo.",
            },
            zh: {
                appTitle: "音乐视频生成器",
                languageLabel: "语言：",
                themeLabel: "主题：",
                themeSystem: "系统",
                themeLight: "浅色",
                themeDark: "深色",
                mainTitle: "🎵 音乐视频生成器 🎬",
                mainDescription: "输入提示以生成一系列图像或上传您自己的图像。将其作为幻灯片与您喜欢的音乐一起播放！",
                tabAiCreate: "AI创作",
                tabUploadImages: "上传图片",
                storyThemeLabel: "整体故事/主题：",
                storyThemePlaceholder: "例如：“一个英雄穿越赛博朋克废土的旅程，从荒凉到希望。”",
                generateStoryboardButton: "✨ 生成故事板提示",
                imagePromptLabel: "图像提示（将由故事板或手动填充）：",
                imagePromptPlaceholder: "例如：“夜晚的未来城市，霓虹灯闪烁，街道上弥漫着微妙的蒸汽，摩天大楼上空弥漫着充满活力的空灵光芒。一个孤独的抽象人物正在观察场景，以丰富纹理和深色调的绘画风格呈现。”",
                enhancePromptButton: "✨ 增强提示",
                llmLoadingMessage: "正在增强提示...",
                loadingGeneratingStoryboards: "正在生成故事板提示...",
                numImagesLabel: "图片数量（最多20张）：",
                imageWidthLabel: "图片宽度：",
                imageHeightLabel: "图片高度：",
                slideshowIntervalLabel: "幻灯片间隔（毫秒）：",
                generateImagesButton: "生成图片",
                playVideoButton: "播放视频",
                stopVideoButton: "停止视频",
                downloadAllImagesButton: "⬇️ 下载所有图片",
                downloadZipButton: "⬇️ 下载视频帧 (ZIP)",
                uploadImagesHeader: "上传您自己的图片",
                uploadInputSpan: "点击此处选择图片",
                loadingIndicatorMessage: "正在生成图片... 这可能需要一些时间。",
                originalImagePreviewHeader: "原始上传图片预览（第一张上传图片）",
                uploadedImageGalleryHeader: "上传图片库（点击 ⬆️ 或 ⬇️ 重新排序）",
                note1: "*请注意：本应用程序不支持直接播放音乐。请在单独的标签页或应用程序中播放您的音乐。*",
                note2: "*此应用程序生成图像序列。要创建完整的视频文件（例如 MP4），请将帧下载为 ZIP，并使用外部视频编辑软件。支持的最大生成图像分辨率为 2K。*",
                alertPromptEmpty: "请输入图像提示或生成故事板提示。",
                alertImageCountInvalid: "请输入1到20之间的有效图像数量。",
                alertImageDimensionsInvalid: "请选择有效的图像尺寸。",
                alertStoryboardThemeEmpty: "请输入一个整体故事或主题来生成故事板提示。",
                alertStoryboardEmpty: "AI 生成了一个空的故事板。请尝试不同的主题。",
                alertStoryboardParseError: "无法从AI解析故事板提示。请重试。",
                alertStoryboardLLMContentError: "无法生成故事板提示。AI 可能没有返回有效内容。请重试。",
                alertImageGenHTTPError: "生成图片时出错。这可能是由于环境中的API密钥配置问题。如果问题仍然存在，请联系支持人员。",
                alertImageGenNoPrediction: "错误：无法生成一张或多张图片。图片生成服务可能未返回有效的图片数据。请尝试不同的提示或更小的分辨率。",
                alertImageGenUnhandledError: "生成图片时发生意外错误。请检查控制台以获取详细信息并重试。",
                alertEnhancePromptEmpty: "请输入要增强的提示。",
                alertEnhancePromptConflict: "当故事板处于活动状态或正在使用上传的图像时，无法增强单个提示。请清除内容以增强主提示。",
                alertEnhancePromptHTTPError: "增强提示时出错：",
                alertEnhancePromptLLMContentError: "无法增强提示。LLM 可能没有返回有效文本。请重试或重新措辞您的原始提示。",
                alertEnhancePromptUnhandledError: "增强提示时发生意外错误。请检查控制台以获取详细信息并重试。",
                alertNoImagesToDownload: "没有图片可供下载。请先生成或上传图片。",
                alertNoImagesToZip: "没有图片可供压缩。请先生成或上传图片。",
                alertZipError: "创建或下载 ZIP 文件时发生错误。请重试。",
                alertUploadFileReadError: "无法读取文件：",
                alertNoValidImagesUploaded: "未上传任何有效图片。",
                alertUploadUnhandledError: "上传过程中发生错误。",
                uploadProcessing: "正在处理 {{count}} 张图片...",
                uploadedReady: "{{count}} 张图片已上传并准备就绪！",
                loadingGenerating: "正在生成图片... 这可能需要一些时间。",
                loadingUploading: "正在上传图片... 这可能需要一些时间。",
                loadingCreatingZip: "正在创建 ZIP 文件...",
                galleryStatus: "正在显示 {{count}} 张已上传图片。",
                moveUp: "⬆️ 上移",
                moveDown: "⬇️ 下移",
                slideshowStartAlert: "请先生成或上传图片以开始幻灯片播放。",
                slideshowInvalidInterval: "请输入一个有效的间隔（至少100毫秒）。",
                alertNoImagesGenerated: "没有图片被生成。请检查您的提示并重试。",
            }
        };

        let currentLanguage = 'en'; // Default language

        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const languageSelect = document.getElementById('language-select');
        const themeSelect = document.getElementById('theme-select'); // NEW

        // Existing elements
        const storyThemeInput = document.getElementById('story-theme-input');
        const generateStoryboardButton = document.getElementById('generate-storyboard-button');
        const promptInput = document.getElementById('prompt-input');
        const imageCountInput = document.getElementById('image-count');
        const imageWidthSelect = document.getElementById('image-width');
        const imageHeightSelect = document.getElementById('image-height');
        const intervalInput = document.getElementById('interval-input');
        const generateButton = document.getElementById('generate-button');
        const playButton = document.getElementById('play-button');
        const stopButton = document.getElementById('stop-button');
        const downloadImagesButton = document.getElementById('download-images-button');
        const downloadZipButton = document.getElementById('download-zip-button');
        const imageDisplay = document.getElementById('image-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const enhancePromptButton = document.getElementById('enhance-prompt-button');
        const llmLoadingIndicator = document.getElementById('llm-loading-indicator');
        const uploadInput = document.getElementById('upload-input');
        const uploadInputContainerDiv = document.getElementById('upload-input-container-div');
        const uploadStatus = document.getElementById('upload-status');
        const originalImagePreviewContainer = document.getElementById('original-image-preview-container');
        const originalImagePreview = document.getElementById('original-image-preview');
        const uploadedImageGalleryContainer = document.getElementById('uploaded-image-gallery-container');
        const uploadedImageGallery = document.getElementById('uploaded-image-gallery');
        const galleryStatus = document.getElementById('gallery-status');


        let generatedImages = [];
        let currentImageIndex = 0;
        let slideshowInterval;
        let isFromUpload = false;
        let storyboardPrompts = [];
        let isGeneratingStoryboard = false;

        /**
         * Applies the selected theme to the body.
         * @param {string} themeName 'light', 'dark', or 'system'.
         */
        function applyTheme(themeName) {
            console.log(`[applyTheme] Applying theme: ${themeName}`);
            const body = document.body;
            body.removeAttribute('data-theme'); // Clear any existing theme

            if (themeName === 'dark') {
                body.setAttribute('data-theme', 'dark');
            } else if (themeName === 'light') {
                // Light theme is the default via CSS variables on :root, so no data-theme needed
            } else if (themeName === 'system') {
                // Check system preference immediately
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.setAttribute('data-theme', 'dark');
                }
                // The media query listener will handle subsequent changes
            }
            localStorage.setItem('selectedTheme', themeName);
            console.log(`[applyTheme] Theme set to: ${themeName}, saved to localStorage.`);
        }

        /**
         * Handles changes to the system's preferred color scheme when 'system' theme is active.
         * @param {MediaQueryListEvent} event
         */
        const systemThemeChangeHandler = (event) => {
            if (themeSelect.value === 'system') { // Only react if 'system' theme is chosen
                console.log(`[systemThemeChangeHandler] System theme changed. Dark mode active: ${event.matches}`);
                if (event.matches) { // If system switches to dark
                    document.body.setAttribute('data-theme', 'dark');
                } else { // If system switches to light
                    document.body.removeAttribute('data-theme');
                }
            }
        };

        // Listen for system theme changes globally
        const mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQueryList.addEventListener('change', systemThemeChangeHandler);

        /**
         * Translates all elements with a data-key attribute to the current language.
         */
        function applyTranslations() {
            console.log(`[applyTranslations] Applying translations for language: ${currentLanguage}`);
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                const translation = translations[currentLanguage][key];
                if (translation) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translation;
                    } else if (element.tagName === 'TEXTAREA' && element.hasAttribute('placeholder')) {
                        element.placeholder = translation;
                    } else if (element.tagName === 'TITLE') {
                        document.title = translation; // Update page title
                    } else if (element.dataset.tab) {
                        // For tab buttons, update text content directly while preserving SVG
                        const svgHtml = element.querySelector('svg') ? element.querySelector('svg').outerHTML : '';
                        element.innerHTML = `${svgHtml} ${translation}`;
                    } else if (element.tagName === 'OPTION' && element.closest('#theme-select')) {
                        // This specific logic is handled by `applyThemeOptionsTranslations` below.
                    }
                    else {
                        element.textContent = translation;
                    }
                }
            });

            // Specific translation for theme options as they are not standard data-key elements
            applyThemeOptionsTranslations();


            // Update specific dynamic messages
            llmLoadingIndicator.textContent = isGeneratingStoryboard ? translations[currentLanguage].loadingGeneratingStoryboards : translations[currentLanguage].llmLoadingMessage;
            if (loadingIndicator.style.display !== 'none') {
                 loadingIndicator.textContent = isFromUpload ? translations[currentLanguage].loadingUploading : translations[currentLanguage].loadingGenerating;
            }
            if (uploadStatus.style.display !== 'none') {
                // Get the original text content to extract numbers before translation
                const originalUploadStatusText = uploadStatus.textContent;
                const countMatch = originalUploadStatusText.match(/\d+/);
                const count = countMatch ? parseInt(countMatch[0], 10) : 0;

                // Check for keywords from the *English* version of the original text to determine the state
                if (originalUploadStatusText.includes("Processing")) {
                    uploadStatus.textContent = translations[currentLanguage].uploadProcessing.replace('{{count}}', count);
                } else if (originalUploadStatusText.includes("uploaded and ready")) {
                     uploadStatus.textContent = translations[currentLanguage].uploadedReady.replace('{{count}}', count);
                } else if (originalUploadStatusText.includes("No valid images")) {
                    uploadStatus.textContent = translations[currentLanguage].alertNoValidImagesUploaded;
                } else if (originalUploadStatusText.includes("error")) {
                    uploadStatus.textContent = translations[currentLanguage].alertUploadUnhandledError;
                }
            }
            if (galleryStatus.style.display !== 'none') {
                const originalGalleryStatusText = galleryStatus.textContent;
                const countMatch = originalGalleryStatusText.match(/\d+/);
                const count = countMatch ? parseInt(countMatch[0], 10) : 0;
                galleryStatus.textContent = translations[currentLanguage].galleryStatus.replace('{{count}}', count);
            }

            // Update gallery buttons if gallery is visible
            if (uploadedImageGalleryContainer.style.display === 'block') {
                document.querySelectorAll('.gallery-item .item-controls button:first-child').forEach(btn => {
                    btn.textContent = translations[currentLanguage].moveUp;
                });
                document.querySelectorAll('.gallery-item .item-controls button:last-child').forEach(btn => {
                    btn.textContent = translations[currentLanguage].moveDown;
                });
            }
        }

        /**
         * Translates the text content of theme options based on their data-key.
         */
        function applyThemeOptionsTranslations() {
            document.querySelectorAll('#theme-select option').forEach(option => {
                const key = `theme${option.value.charAt(0).toUpperCase() + option.value.slice(1)}`; // e.g., 'themeSystem', 'themeLight', 'themeDark'
                if (translations[currentLanguage][key]) {
                    option.textContent = translations[currentLanguage][key];
                }
            });
        }


        /**
         * Shows the selected tab and hides others.
         * @param {string} tabId The ID of the tab to show (e.g., 'ai-create', 'upload').
         */
        function showTab(tabId) {
            console.log(`[showTab] Switching to tab: ${tabId}`);
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`${tabId}-tab-content`).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

            // Adjust overall UI state based on active tab after the switch
            updateUIState(false, false, false, false);
        }

        /**
         * Disables/enables UI elements during various states (loading, playing, etc.).
         * @param {boolean} isLoading True if generating images, false otherwise.
         * @param {boolean} isLlmLoading True if enhancing prompt/storyboard, false otherwise.
         * @param {boolean} isPlaying True if slideshow is playing, false otherwise.
         * @param {boolean} isUploading True if images are being uploaded, false otherwise.
         */
        function updateUIState(isLoading, isLlmLoading, isPlaying, isUploading) {
            console.log(`[updateUIState] Called with: isLoading=${isLoading}, isLlmLoading=${isLlmLoading}, isPlaying=${isPlaying}, isUploading=${isUploading}`);

            // Determine active tab (now only 'ai-create' or 'upload')
            const activeTab = document.querySelector('.tab-button.active')?.dataset.tab;

            // Common disabling logic for AI-related inputs
            const disableAIRelatedInputs = isLoading || isLlmLoading || isPlaying || isUploading || isFromUpload;

            // Prompt input, enhance button, image count input disabled if generating/uploading/playing,
            // or if storyboard is active (in 'ai-create' tab), or if images are uploaded.
            // These inputs are ONLY relevant to AI generation.
            promptInput.disabled = disableAIRelatedInputs || (storyboardPrompts.length > 0 && activeTab === 'ai-create');
            enhancePromptButton.disabled = disableAIRelatedInputs || (storyboardPrompts.length > 0 && activeTab === 'ai-create');
            imageCountInput.disabled = disableAIRelatedInputs || (storyboardPrompts.length > 0 && activeTab === 'ai-create');


            // Image size and interval inputs are generally disabled during any active process
            imageWidthSelect.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
            imageHeightSelect.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
            intervalInput.disabled = isLoading || isLlmLoading || isPlaying || isUploading;

            // Generate button is disabled during any active process
            generateButton.disabled = isLoading || isLlmLoading || isPlaying || isUploading;

            // Upload input and its container are disabled during any active process
            uploadInput.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
            uploadInputContainerDiv.style.pointerEvents = (isLoading || isLlmLoading || isPlaying || isUploading) ? 'none' : 'auto';

            // Storyboard specific controls
            storyThemeInput.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
            generateStoryboardButton.disabled = isLoading || isLlmLoading || isPlaying || isUploading;

            // Tab buttons themselves should be disabled during any active process
            tabButtons.forEach(button => {
                button.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
                button.style.pointerEvents = (isLoading || isLlmLoading || isPlaying || isUploading) ? 'none' : 'auto';
            });

            // Language and Theme selects should also be disabled during heavy processing
            languageSelect.disabled = isLoading || isLlmLoading || isPlaying || isUploading;
            themeSelect.disabled = isLoading || isLlmLoading || isPlaying || isUploading;


            // Image display and specific button states
            if (isLoading || isUploading) {
                loadingIndicator.style.display = 'block';
                loadingIndicator.textContent = isLoading ? translations[currentLanguage].loadingGenerating : translations[currentLanguage].loadingUploading;
                imageDisplay.style.display = 'none';
                playButton.disabled = true;
                stopButton.disabled = true;
                downloadImagesButton.disabled = true;
                downloadZipButton.disabled = true;
                uploadStatus.style.display = 'none';
                originalImagePreviewContainer.style.display = 'none'; // Hide preview during any processing
                uploadedImageGalleryContainer.style.display = 'none'; // Hide gallery during processing
            } else {
                loadingIndicator.style.display = 'none';
                if (generatedImages.length > 0) {
                    imageDisplay.style.display = 'block';
                    playButton.disabled = isPlaying;
                    downloadImagesButton.disabled = false;
                    downloadZipButton.disabled = false;

                    // Show original image preview and gallery only if images came from upload
                    originalImagePreviewContainer.style.display = isFromUpload ? 'block' : 'none';
                    uploadedImageGalleryContainer.style.display = isFromUpload ? 'block' : 'none';
                } else {
                    imageDisplay.style.display = 'none';
                    playButton.disabled = true;
                    downloadImagesButton.disabled = true;
                    downloadZipButton.disabled = true;
                    originalImagePreviewContainer.style.display = 'none';
                    uploadedImageGalleryContainer.style.display = 'none';
                }
                stopButton.disabled = !isPlaying;
            }

            // LLM loading indicator state (for prompt enhancement AND storyboard generation)
            llmLoadingIndicator.style.display = isLlmLoading ? 'block' : 'none';
            llmLoadingIndicator.textContent = isGeneratingStoryboard ? translations[currentLanguage].loadingGeneratingStoryboards : translations[currentLanguage].llmLoadingMessage;
            console.log(`[updateUIState] UI state updated.`);
        }

        /**
         * Clears all existing images and resets the slideshow state.
         * Also resets the `isFromUpload` flag and storyboard related variables.
         */
        function clearAndResetImages() {
            console.log("[clearAndResetImages] Clearing and resetting images and slideshow state.");
            generatedImages = [];
            currentImageIndex = 0;
            stopSlideshow();
            imageDisplay.src = '';
            imageDisplay.style.display = 'none';
            uploadStatus.textContent = '';
            uploadStatus.style.display = 'none';
            originalImagePreview.src = '';
            originalImagePreviewContainer.style.display = 'none';
            uploadedImageGallery.innerHTML = ''; // Clear gallery content
            uploadedImageGalleryContainer.style.display = 'none'; // Hide gallery container
            galleryStatus.textContent = '';
            galleryStatus.style.display = 'none';

            isFromUpload = false;
            storyboardPrompts = [];
            // Re-enable inputs for AI creation mode (as they would be if no storyboard was active)
            imageCountInput.disabled = false;
            promptInput.disabled = false;
            enhancePromptButton.disabled = false;
            console.log("[clearAndResetImages] Images and state reset.");
        }

        /**
         * Generates a sequence of detailed image prompts based on a high-level story/theme using Gemini API.
         */
        async function generateStoryboardPrompts() {
            console.log("[generateStoryboardPrompts] Generate Storyboard Prompts button clicked.");
            const storyTheme = storyThemeInput.value.trim();
            if (!storyTheme) {
                alert(translations[currentLanguage].alertStoryboardThemeEmpty);
                console.warn("[generateStoryboardPrompts] Story/Theme is empty.");
                return;
            }

            clearAndResetImages();
            isGeneratingStoryboard = true;
            updateUIState(false, true, false, false); // Show LLM loading for storyboard

            try {
                let chatHistory = [];
                chatHistory.push({
                    role: "user",
                    parts: [{
                        text: `Generate a sequence of 5 to 10 detailed image prompts that tell a cohesive visual story based on the theme: "${storyTheme}". Each prompt should describe a distinct scene or progression in the narrative, suitable for a music video. Provide the prompts as a JSON array of strings. Example: ["prompt 1", "prompt 2", "prompt 3"]. Only return the JSON array, no other text.`
                    }]
                });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: { "type": "STRING" }
                        }
                    }
                };
                const apiKey = "AIzaSyAENz8Z47uov-EhdZnBSfhMZ0efK60szPE"; // API key is provided by the Canvas environment at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyAENz8Z47uov-EhdZnBSfhMZ0efK60szPE`;

                console.log("[generateStoryboardPrompts] Initiating fetch for storyboard prompts with payload:", payload);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(`[generateStoryboardPrompts] Response status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('[generateStoryboardPrompts] HTTP error:', errorData);
                    alert(`${translations[currentLanguage].alertImageGenHTTPError} ${errorData.error ? errorData.error.message : response.statusText}.`);
                    return;
                }

                const result = await response.json();
                console.log("[generateStoryboardPrompts] Raw LLM result:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;

                    // NEW: Check for empty or non-string content before JSON.parse
                    if (typeof jsonString !== 'string' || !jsonString.trim()) {
                        console.error('[generateStoryboardPrompts] LLM returned non-string or empty content where JSON was expected:', jsonString);
                        alert(translations[currentLanguage].alertStoryboardParseError + " (AI returned empty/invalid content).");
                        imageCountInput.disabled = false;
                        enhancePromptButton.disabled = false;
                        return; // Exit if content is not a valid string for JSON parsing
                    }

                    try {
                        const parsedPrompts = JSON.parse(jsonString);
                        if (Array.isArray(parsedPrompts) && parsedPrompts.every(p => typeof p === 'string')) {
                            storyboardPrompts = parsedPrompts;
                            if (storyboardPrompts.length > 0) {
                                promptInput.value = storyboardPrompts[0]; // Set the first prompt
                                imageCountInput.value = storyboardPrompts.length; // Set image count to storyboard length
                                // Disable related inputs as they are now controlled by storyboard
                                imageCountInput.disabled = true;
                                enhancePromptButton.disabled = true;
                                console.log(`[generateStoryboardPrompts] Storyboard generated successfully. Number of prompts: ${storyboardPrompts.length}`);
                            } else {
                                alert(translations[currentLanguage].alertStoryboardEmpty);
                                console.warn("[generateStoryboardPrompts] AI returned empty array.");
                                // Re-enable inputs if storyboard is empty
                                imageCountInput.disabled = false;
                                enhancePromptButton.disabled = false;
                            }
                        } else {
                            throw new Error("Invalid JSON structure received. Expected array of strings.");
                        }
                    } catch (parseError) {
                        console.error('[generateStoryboardPrompts] Error parsing JSON response:', parseError, 'Raw JSON string:', jsonString);
                        alert(translations[currentLanguage].alertStoryboardParseError);
                         // Re-enable inputs on parse error
                        imageCountInput.disabled = false;
                        enhancePromptButton.disabled = false;
                    }
                } else {
                    console.error('[generateStoryboardPrompts] Failed to get storyboard prompts from LLM (no content or unexpected structure):', result);
                    alert(translations[currentLanguage].alertStoryboardLLMContentError);
                    // Re-enable inputs if LLM returns no content
                    imageCountInput.disabled = false;
                    enhancePromptButton.disabled = false;
                }
            } catch (error) { // This outer catch handles general errors like network issues
                console.error('[generateStoryboardPrompts] An unhandled error occurred:', error);
                alert(`${translations[currentLanguage].alertStoryboardUnhandledError}: ${error.message || "Unknown error."}`); // Improved error message
                 // Re-enable inputs on unhandled error
                imageCountInput.disabled = false;
                enhancePromptButton.disabled = false;
            } finally {
                isGeneratingStoryboard = false;
                updateUIState(false, false, false, false);
                console.log("[generateStoryboardPrompts] Storyboard generation process finished. UI state updated.");
            }
        }


        /**
         * Generates images based on the user prompt/storyboard using the Imagen API.
         */
        async function generateImages() {
            console.log("[generateImages] Generate Images button clicked.");
            clearAndResetImages(); // Always clear previous content (uploaded or generated)

            const imageWidth = parseInt(imageWidthSelect.value, 10);
            const imageHeight = parseInt(imageHeightSelect.value, 10);

            let promptsToUse = [];

            if (storyboardPrompts.length > 0) {
                promptsToUse = storyboardPrompts;
                console.log("[generateImages] Using storyboard prompts for image generation.");
            } else {
                const initialPrompt = promptInput.value.trim();
                const imageCount = parseInt(imageCountInput.value, 10);

                if (!initialPrompt) {
                    alert(translations[currentLanguage].alertPromptEmpty);
                    console.warn("[generateImages] Prompt is empty and no storyboard exists.");
                    return;
                }
                if (isNaN(imageCount) || imageCount < 1 || imageCount > 20) {
                    alert(translations[currentLanguage].alertImageCountInvalid);
                    console.warn("[generateImages] Invalid image count:", imageCount);
                    return;
                }
                for(let i=0; i<imageCount; i++) {
                    promptsToUse.push(`${initialPrompt} - frame ${i + 1} of ${imageCount}`);
                }
                console.log("[generateImages] Using single prompt input for image generation.");
            }


            if (isNaN(imageWidth) || isNaN(imageHeight) || imageWidth < 1 || imageHeight < 1) {
                alert(translations[currentLanguage].alertImageDimensionsInvalid);
                console.warn("[generateImages] Invalid image dimensions:", imageWidth, imageHeight);
                return;
            }

            console.log("[generateImages] Preparing to generate images. Prompts count:", promptsToUse.length, "width:", imageWidth, "height:", imageHeight);
            updateUIState(true, false, false, false);

            try {
                for (let i = 0; i < promptsToUse.length; i++) {
                    const currentGenPrompt = promptsToUse[i];
                    const payload = {
                        instances: { prompt: currentGenPrompt },
                        parameters: {
                            "sampleCount": 1,
                            "width": imageWidth,
                            "height": imageHeight
                        }
                    };
                    const apiKey = "AIzaSyCzBLGr4RfFHeOY-0K3Wq2rxRTYhTBdNOA; // API key is provided by the Canvas environment at runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    console.log(`[generateImages] Initiating fetch for image ${i + 1}/${promptsToUse.length} with prompt: "${currentGenPrompt}"`);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log(`[generateImages] Response status for image ${i + 1}: ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error(`[generateImages] HTTP error for image ${i + 1}:`, errorData);
                        alert(`${translations[currentLanguage].alertImageGenHTTPError} ${errorData.error ? errorData.error.message : response.statusText}.`);
                        break;
                    }

                    const result = await response.json();
                    console.log(`[generateImages] Raw result for image ${i + 1}:`, result);

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        generatedImages.push(imageUrl);
                        console.log(`[generateImages] Image ${i + 1} generated successfully. Total generated: ${generatedImages.length}`);
                    } else {
                        console.error('[generateImages] Failed to generate image (no prediction data):', result);
                        alert(translations[currentLanguage].alertImageGenNoPrediction);
                        break;
                    }
                }

                if (generatedImages.length > 0) {
                    imageDisplay.src = generatedImages[0];
                    imageDisplay.style.display = 'block';
                    console.log(`[generateImages] Successfully generated ${generatedImages.length} images. Displaying first image.`);
                } else {
                    translations[currentLanguage].alertNoImagesGenerated = translations[currentLanguage].alertNoImagesGenerated || "No images were generated. Please check your prompt and try again.";
                    alert(translations[currentLanguage].alertNoImagesGenerated);
                    console.log("[generateImages] No images were successfully generated.");
                }

            } catch (error) {
                console.error('[generateImages] An unhandled error occurred during image generation:', error);
                alert(`${translations[currentLanguage].alertImageGenUnhandledError}: ${error.message || "Unknown error."}`); // Improved error message
            } finally {
                updateUIState(false, false, false, false);
                console.log("[generateImages] Generate Images process finished. UI state updated.");
            }
        }

        /**
         * Enhances the user's prompt using the Gemini LLM.
         */
        async function enhancePrompt() {
            console.log("[enhancePrompt] Enhance Prompt button clicked.");
            const currentPrompt = promptInput.value.trim();
            if (!currentPrompt) {
                alert(translations[currentLanguage].alertEnhancePromptEmpty);
                console.warn("[enhancePrompt] Prompt is empty for enhancement.");
                return;
            }
            if (storyboardPrompts.length > 0 || isFromUpload) {
                 alert(translations[currentLanguage].alertEnhancePromptConflict);
                 console.warn("[enhancePrompt] Attempted to enhance prompt while storyboard is active or images are uploaded.");
                 return;
            }

            console.log("[enhancePrompt] Enhancing prompt:", currentPrompt);
            updateUIState(false, true, false, false);

            try {
                let chatHistory = [];
                chatHistory.push({
                    role: "user",
                    parts: [{
                        text: `Refine and expand the following image generation prompt to make it more detailed and visually rich. Suggest specific styles, elements, or atmospheres. Provide only the enhanced prompt as plain text, with no introductory or concluding remarks.\n\nOriginal prompt: "${currentPrompt}"`
                    }]
                });

                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAENz8Z47uov-EhdZnBSfhMZ0efK60szPE; // API key is provided by the Canvas environment at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log("[enhancePrompt] Initiating fetch for prompt enhancement with payload:", payload);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(`[enhancePrompt] Response status for enhance prompt: ${response.status} ${response.statusText}`);

                 if (!response.ok) {
                    const errorData = await response.json();
                    console.error('[enhancePrompt] HTTP error during prompt enhancement:', errorData);
                    alert(`${translations[currentLanguage].alertEnhancePromptHTTPError} ${errorData.error ? errorData.error.message : response.statusText}.`);
                    return;
                }

                const result = await response.json();
                console.log("[enhancePrompt] Raw result for enhance prompt:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const enhancedText = result.candidates[0].content.parts[0].text;
                    promptInput.value = enhancedText.trim();
                    console.log("[enhancePrompt] Prompt enhanced successfully. New prompt:", promptInput.value);
                } else {
                    console.error('[enhancePrompt] Failed to get enhanced prompt from LLM (no content):', result);
                    alert(translations[currentLanguage].alertEnhancePromptLLMContentError);
                }
            } catch (error) {
                console.error('[enhancePrompt] An unhandled error occurred during prompt enhancement:', error);
                alert(`${translations[currentLanguage].alertEnhancePromptUnhandledError}: ${error.message || "Unknown error."}`); // Improved error message
            } finally {
                updateUIState(false, false, false, false);
                console.log("[enhancePrompt] Enhance Prompt process finished. UI state updated.");
            }
        }

        /**
         * Renders the uploaded images in the gallery with reordering controls.
         */
        function renderUploadedImageGallery() {
            uploadedImageGallery.innerHTML = ''; // Clear existing thumbnails
            if (generatedImages.length === 0) {
                uploadedImageGalleryContainer.style.display = 'none';
                return;
            }

            uploadedImageGalleryContainer.style.display = 'block';
            galleryStatus.textContent = translations[currentLanguage].galleryStatus.replace('{{count}}', generatedImages.length);
            galleryStatus.style.display = 'block';

            generatedImages.forEach((imageUrl, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.dataset.index = index;

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `Uploaded Image ${index + 1}`;
                galleryItem.appendChild(img);

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'item-controls';

                const moveUpButton = document.createElement('button');
                moveUpButton.textContent = translations[currentLanguage].moveUp;
                moveUpButton.onclick = () => moveImageInGallery(index, -1);
                moveUpButton.disabled = index === 0;
                controlsDiv.appendChild(moveUpButton);

                const moveDownButton = document.createElement('button');
                moveDownButton.textContent = translations[currentLanguage].moveDown;
                moveDownButton.onclick = () => moveImageInGallery(index, 1);
                moveDownButton.disabled = index === generatedImages.length - 1;
                controlsDiv.appendChild(moveDownButton);

                galleryItem.appendChild(controlsDiv);
                uploadedImageGallery.appendChild(galleryItem);
            });
            console.log("[renderUploadedImageGallery] Gallery re-rendered with image thumbnails and controls.");
        }

        /**
         * Moves an image within the generatedImages array and re-renders the gallery.
         * @param {number} oldIndex The current index of the image.
         * @param {number} direction -1 to move up, 1 to move down.
         */
        function moveImageInGallery(oldIndex, direction) {
            const newIndex = oldIndex + direction;

            if (newIndex >= 0 && newIndex < generatedImages.length) {
                const [movedImage] = generatedImages.splice(oldIndex, 1);
                generatedImages.splice(newIndex, 0, movedImage);
                console.log(`[moveImageInGallery] Moved image from ${oldIndex} to ${newIndex}.`);
                renderUploadedImageGallery();
                // Update main display if it was showing the moved image or the first image
                if (!slideshowInterval || oldIndex === currentImageIndex || newIndex === currentImageIndex) {
                    imageDisplay.src = generatedImages[currentImageIndex]; // Keep current image in sync with new order
                }
            }
        }


        /**
         * Handles the upload of user images.
         * @param {Event} event The change event from the file input.
         */
        async function uploadImages(event) {
            console.log("[uploadImages] Upload input change event triggered.");
            clearAndResetImages(); // Ensure clean slate (clears storyboard as well)
            isFromUpload = true; // Set flag at the beginning of upload process

            const files = event.target.files;
            console.log(`[uploadImages] Number of files selected: ${files.length}`);

            if (files.length === 0) {
                console.log("[uploadImages] No files selected for upload.");
                uploadStatus.textContent = '';
                uploadStatus.style.display = 'none';
                isFromUpload = false;
                updateUIState(false, false, false, false);
                return;
            }

            console.log(`[uploadImages] Attempting to upload ${files.length} images.`);
            uploadStatus.textContent = translations[currentLanguage].uploadProcessing.replace('{{count}}', files.length);
            uploadStatus.style.display = 'block';
            updateUIState(false, false, false, true);

            let loadedCount = 0;
            const promises = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) {
                    console.warn(`[uploadImages] Skipping non-image file: ${file.name}`);
                    continue;
                }

                const reader = new FileReader();
                promises.push(new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        console.log(`[uploadImages] File ${file.name} loaded successfully as Data URL.`);
                        generatedImages.push(e.target.result);
                        loadedCount++;
                        uploadStatus.textContent = translations[currentLanguage].uploadProcessing.replace('{{count}}', loadedCount);
                        resolve();
                    };
                    reader.onerror = (error) => {
                        console.error('[uploadImages] Error reading file:', file.name, error);
                        alert(`${translations[currentLanguage].alertUploadFileReadError} ${file.name}.`);
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                }));
            }

            try {
                await Promise.all(promises);
                console.log("[uploadImages] All uploaded image promises resolved. Total images collected:", generatedImages.length);
                if (generatedImages.length > 0) {
                    imageDisplay.src = generatedImages[0];
                    imageDisplay.style.display = 'block';
                    originalImagePreview.src = generatedImages[0];
                    originalImagePreviewContainer.style.display = 'block';

                    renderUploadedImageGallery(); // Render the gallery with uploaded images

                    uploadStatus.textContent = translations[currentLanguage].uploadedReady.replace('{{count}}', generatedImages.length);
                    uploadStatus.style.display = 'block';
                    console.log(`[uploadImages] Successfully uploaded ${generatedImages.length} images. isFromUpload set to true.`);
                } else {
                    uploadStatus.textContent = translations[currentLanguage].alertNoValidImagesUploaded;
                    uploadStatus.style.display = 'block';
                    console.log("[uploadImages] No valid images were uploaded.");
                    isFromUpload = false;
                }
            } catch (error) {
                console.error('[uploadImages] Error during image upload process:', error);
                uploadStatus.textContent = translations[currentLanguage].alertUploadUnhandledError;
                uploadStatus.style.display = 'block';
                isFromUpload = false;
            } finally {
                updateUIState(false, false, false, false);
                console.log("[uploadImages] Upload Images process finished. UI state updated.");
            }
        }


        /**
         * Displays the next image in the slideshow.
         */
        function showNextImage() {
            if (generatedImages.length === 0) {
                console.warn("[showNextImage] called but no images in queue. Stopping slideshow.");
                stopSlideshow();
                return;
            }
            console.log(`[showNextImage] Displaying image ${currentImageIndex + 1} of ${generatedImages.length}`);
            imageDisplay.src = generatedImages[currentImageIndex];
            imageDisplay.style.display = 'block';
            currentImageIndex = (currentImageIndex + 1) % generatedImages.length;
        }

        /**
         * Starts the slideshow.
         */
        function startSlideshow() {
            console.log("[startSlideshow] Start Slideshow button clicked.");
            if (generatedImages.length === 0) {
                alert(translations[currentLanguage].slideshowStartAlert);
                console.warn("[startSlideshow] Attempted to start slideshow with no images.");
                return;
            }

            const interval = parseInt(intervalInput.value, 10);
            if (isNaN(interval) || interval < 100) {
                alert(translations[currentLanguage].slideshowInvalidInterval);
                console.warn("[startSlideshow] Invalid interval input:", interval);
                return;
            }

            stopSlideshow();
            updateUIState(false, false, true, false);

            currentImageIndex = 0;
            showNextImage();

            slideshowInterval = setInterval(showNextImage, interval);
            console.log(`[startSlideshow] Slideshow started with interval: ${interval}ms.`);
        }

        /**
         * Stops the slideshow.
         */
        function stopSlideshow() {
            console.log("[stopSlideshow] Stop Slideshow button clicked.");
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
                console.log("[stopSlideshow] Slideshow stopped.");
            }
            updateUIState(false, false, false, false);
        }

        /**
         * Downloads all current images individually (whether generated or uploaded).
         */
        function downloadAllImages() {
            console.log("[downloadAllImages] Download All Images button clicked.");
            if (generatedImages.length === 0) {
                alert(translations[currentLanguage].alertNoImagesToDownload);
                console.warn("[downloadAllImages] Attempted to download with no images.");
                return;
            }

            generatedImages.forEach((imageUrl, index) => {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `music_video_image_${index + 1}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log(`[downloadAllImages] Triggered download for music_video_image_${index + 1}.png`);
            });
        }

        /**
         * Downloads all current images as a single ZIP file (whether generated or uploaded).
         */
        async function downloadImagesAsZip() {
            console.log("[downloadImagesAsZip] Download Video Frames (ZIP) button clicked.");
            if (generatedImages.length === 0) {
                alert(translations[currentLanguage].alertNoImagesToZip);
                console.warn("[downloadImagesAsZip] Attempted to zip with no images.");
                return;
            }

            const zip = new JSZip();
            llmLoadingIndicator.textContent = translations[currentLanguage].loadingCreatingZip;
            updateUIState(false, true, false, false);

            try {
                for (let i = 0; i < generatedImages.length; i++) {
                    const imageUrl = generatedImages[i];
                    if (imageUrl.startsWith('data:image/')) {
                        const base64Data = imageUrl.split(',')[1];
                        zip.file(`music_video_image_${i + 1}.png`, base64Data, { base64: true });
                        console.log(`[downloadImagesAsZip] Added image ${i + 1} to ZIP.`);
                    } else {
                        console.warn(`[downloadImagesAsZip] Skipping non-data URL image for ZIP: ${imageUrl}. Ensure images are loaded as data URLs.`);
                    }
                }

                console.log("[downloadImagesAsZip] Generating ZIP file asynchronously...");
                const blob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'music_video_frames.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                console.log("[downloadImagesAsZip] ZIP file download triggered.");

            } catch (error) {
                console.error('[downloadImagesAsZip] Error creating or downloading ZIP:', error);
                alert(translations[currentLanguage].alertZipError);
            } finally {
                llmLoadingIndicator.textContent = translations[currentLanguage].llmLoadingMessage;
                updateUIState(false, false, false, false);
                console.log("[downloadImagesAsZip] ZIP download process finished. UI state updated.");
            }
        }


        // Event Listeners
        generateButton.addEventListener('click', generateImages);
        playButton.addEventListener('click', startSlideshow);
        stopButton.addEventListener('click', stopSlideshow);
        enhancePromptButton.addEventListener('click', enhancePrompt);
        downloadImagesButton.addEventListener('click', downloadAllImages);
        downloadZipButton.addEventListener('click', downloadImagesAsZip);
        generateStoryboardButton.addEventListener('click', generateStoryboardPrompts);

        // Tab button event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Language selector event listener
        languageSelect.addEventListener('change', (event) => {
            currentLanguage = event.target.value;
            localStorage.setItem('selectedLanguage', currentLanguage); // Save selected language
            applyTranslations();
            // Re-render gallery to update button texts
            if (isFromUpload && uploadedImageGallery.children.length > 0) {
                 renderUploadedImageGallery();
            }
        });

        // Theme selector event listener
        themeSelect.addEventListener('change', (event) => {
            applyTheme(event.target.value);
        });


        // Explicitly trigger the hidden file input when the container div is clicked
        uploadInputContainerDiv.addEventListener('click', () => {
            console.log("[Event Listener] Upload container div clicked, programmatically clicking hidden file input.");
            uploadInput.click();
        });
        uploadInput.addEventListener('change', uploadImages);


        // Initial state on load
        // Set initial language from localStorage or default to 'en'
        const savedLanguage = localStorage.getItem('selectedLanguage');
        if (savedLanguage && translations[savedLanguage]) {
            currentLanguage = savedLanguage;
            languageSelect.value = savedLanguage;
        } else {
            localStorage.setItem('selectedLanguage', 'en'); // Default to English
        }

        // Set initial theme from localStorage or default to 'system'
        const savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme) {
            themeSelect.value = savedTheme;
            applyTheme(savedTheme);
        } else {
            themeSelect.value = 'system'; // Default to system theme
            applyTheme('system');
        }

        showTab('ai-create'); // Show the 'Create with AI' tab by default
        applyTranslations(); // Apply initial translations for all elements
        updateUIState(false, false, false, false);
        console.log("Initial UI state set. Application ready.");
    </script>
</body>
</html>
�
